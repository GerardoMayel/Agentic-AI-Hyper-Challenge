<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claims Management - Analyst Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .loading { opacity: 0.6; pointer-events: none; }
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-approved { @apply bg-green-100 text-green-800; }
        .status-rejected { @apply bg-red-100 text-red-800; }
        .status-closed { @apply bg-gray-100 text-gray-800; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Claims Management System</h1>
                    <p class="text-sm text-gray-600">Analyst Dashboard</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        üîÑ Refresh
                    </button>
                    <span id="last-updated" class="text-sm text-gray-500"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Stats -->
        <div id="dashboard-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Claims List -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-medium text-gray-900">Claims</h2>
                    <div class="flex space-x-2">
                        <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                            <option value="">All Status</option>
                            <option value="PENDING">Pending</option>
                            <option value="UNDER_REVIEW">Under Review</option>
                            <option value="APPROVED">Approved</option>
                            <option value="REJECTED">Rejected</option>
                            <option value="CLOSED">Closed</option>
                        </select>
                        <select id="priority-filter" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                            <option value="">All Priorities</option>
                            <option value="LOW">Low</option>
                            <option value="NORMAL">Normal</option>
                            <option value="HIGH">High</option>
                            <option value="URGENT">Urgent</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Claim #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="claims-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Claims will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Claim Detail Modal -->
    <div id="claim-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900">Claim Details</h3>
                        <button onclick="closeClaimModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="claim-modal-content" class="p-6">
                    <!-- Claim details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="action-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 id="action-modal-title" class="text-lg font-medium text-gray-900">Action</h3>
                </div>
                <div class="p-6">
                    <div id="action-modal-content">
                        <!-- Action form will be loaded here -->
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeActionModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button id="action-submit-btn" onclick="submitAction()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Submit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentClaimId = null;
        let currentAction = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadClaims();
            
            // Add event listeners for filters
            document.getElementById('status-filter').addEventListener('change', loadClaims);
            document.getElementById('priority-filter').addEventListener('change', loadClaims);
        });

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await axios.get('/api/analyst/dashboard/stats');
                const stats = response.data;
                
                const statsHtml = `
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                        <span class="text-white font-bold">üìã</span>
                                    </div>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Total Claims</dt>
                                        <dd class="text-lg font-medium text-gray-900">${stats.claims_summary.total_claims}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                                        <span class="text-white font-bold">‚è≥</span>
                                    </div>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Pending</dt>
                                        <dd class="text-lg font-medium text-gray-900">${stats.claims_summary.pending_claims}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                        <span class="text-white font-bold">‚úÖ</span>
                                    </div>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Approved</dt>
                                        <dd class="text-lg font-medium text-gray-900">${stats.claims_summary.approved_claims}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                                        <span class="text-white font-bold">üìß</span>
                                    </div>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Processed Emails</dt>
                                        <dd class="text-lg font-medium text-gray-900">${stats.processing_summary.processed_emails}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('dashboard-stats').innerHTML = statsHtml;
                document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load claims list
        async function loadClaims() {
            try {
                const statusFilter = document.getElementById('status-filter').value;
                const priorityFilter = document.getElementById('priority-filter').value;
                
                let url = '/api/analyst/claims?limit=50';
                if (statusFilter) url += `&status=${statusFilter}`;
                if (priorityFilter) url += `&priority=${priorityFilter}`;
                
                const response = await axios.get(url);
                const claims = response.data.claims;
                
                const tableBody = document.getElementById('claims-table-body');
                tableBody.innerHTML = claims.map(claim => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <div>
                                <div class="font-medium">${claim.claim_number}</div>
                                <div class="text-xs text-gray-500">ID: ${claim.id}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div>
                                <div class="font-medium">${claim.customer_name || 'Unknown'}</div>
                                <div class="text-gray-500">${claim.customer_email}</div>
                                ${claim.policy_number ? `<div class="text-xs text-blue-600">Policy: ${claim.policy_number}</div>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div>
                                <div class="font-medium">${claim.claim_type}</div>
                                ${claim.estimated_amount ? `<div class="text-xs text-green-600">$${claim.estimated_amount}</div>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-${claim.status.toLowerCase()}">
                                ${claim.status}
                            </span>
                            ${claim.llm_recommendation ? `<div class="text-xs text-orange-600 mt-1">AI: ${claim.llm_recommendation}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                claim.priority === 'URGENT' ? 'bg-red-100 text-red-800' :
                                claim.priority === 'HIGH' ? 'bg-orange-100 text-orange-800' :
                                claim.priority === 'LOW' ? 'bg-green-100 text-green-800' :
                                'bg-blue-100 text-blue-800'
                            }">
                                ${claim.priority}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div>
                                <div>${new Date(claim.created_at).toLocaleDateString()}</div>
                                <div class="text-xs">${new Date(claim.created_at).toLocaleTimeString()}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex flex-col space-y-1">
                                <button onclick="viewClaim(${claim.id})" class="text-blue-600 hover:text-blue-900 text-xs">
                                    üëÅÔ∏è View Details
                                </button>
                                <button onclick="analyzeClaim(${claim.id})" class="text-orange-600 hover:text-orange-900 text-xs">
                                    ü§ñ AI Analysis
                                </button>
                                <button onclick="showActionModal('finalize', ${claim.id})" class="text-green-600 hover:text-green-900 text-xs">
                                    ‚úÖ Final Decision
                                </button>
                                <button onclick="showActionModal('dictate', ${claim.id})" class="text-purple-600 hover:text-purple-900 text-xs">
                                    üìù Dictation
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading claims:', error);
            }
        }

        // View claim details
        async function viewClaim(claimId) {
            try {
                const response = await axios.get(`/api/analyst/claims/${claimId}`);
                const claimData = response.data;
                
                const modalContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Claim Information</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Claim Number</dt>
                                    <dd class="text-sm text-gray-900">${claimData.claim.claim_number}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Customer Name</dt>
                                    <dd class="text-sm text-gray-900">${claimData.claim.customer_name}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Customer Email</dt>
                                    <dd class="text-sm text-gray-900">${claimData.claim.customer_email}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Policy Number</dt>
                                    <dd class="text-sm text-gray-900">${claimData.claim.policy_number || 'N/A'}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Claim Type</dt>
                                    <dd class="text-sm text-gray-900">${claimData.claim.claim_type}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Status</dt>
                                    <dd class="text-sm">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-${claimData.claim.status.toLowerCase()}">
                                            ${claimData.claim.status}
                                        </span>
                                    </dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Priority</dt>
                                    <dd class="text-sm text-gray-900">${claimData.claim.priority}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Estimated Amount</dt>
                                    <dd class="text-sm text-gray-900">${claimData.claim.estimated_amount ? `$${claimData.claim.estimated_amount}` : 'N/A'}</dd>
                                </div>
                            </dl>
                        </div>
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-4">LLM Analysis</h4>
                            <div class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Summary</dt>
                                    <dd class="text-sm text-gray-900 mt-1">${claimData.claim.llm_summary || 'No summary available'}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Recommendation</dt>
                                    <dd class="text-sm text-gray-900 mt-1">${claimData.claim.llm_recommendation || 'No recommendation available'}</dd>
                                </div>
                            </div>
                            
                            ${claimData.email ? `
                                <h4 class="text-lg font-medium text-gray-900 mb-4 mt-6">Original Email</h4>
                                <div class="bg-gray-50 p-4 rounded-md">
                                    <div class="text-sm text-gray-600 mb-2">
                                        <strong>From:</strong> ${claimData.email.from_email}<br>
                                        <strong>Subject:</strong> ${claimData.email.subject}<br>
                                        <strong>Received:</strong> ${new Date(claimData.email.received_at).toLocaleString()}
                                    </div>
                                    <div class="text-sm text-gray-900 whitespace-pre-wrap">${claimData.email.body_text}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${claimData.documents && claimData.documents.length > 0 ? `
                        <div class="mt-6">
                            <h4 class="text-lg font-medium text-gray-900 mb-4">Documents (${claimData.documents.length})</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${claimData.documents.map(doc => `
                                    <div class="border border-gray-200 rounded-md p-4">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-medium text-sm">${doc.original_filename}</div>
                                                <div class="text-sm text-gray-500">${doc.document_type} ‚Ä¢ ${(doc.file_size / 1024).toFixed(1)} KB</div>
                                            </div>
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${doc.is_processed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                ${doc.is_processed ? 'Processed' : 'Pending'}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-6 flex space-x-3">
                        <button onclick="showActionModal('finalize', ${claimId})" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            ‚úÖ Finalize Claim
                        </button>
                        <button onclick="showActionModal('dictate', ${claimId})" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                            üìù Create Dictation
                        </button>
                        <button onclick="showActionModal('close', ${claimId})" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            üìß Send Closure Email
                        </button>
                    </div>
                `;
                
                document.getElementById('claim-modal-content').innerHTML = modalContent;
                document.getElementById('claim-modal').classList.remove('hidden');
                currentClaimId = claimId;
                
            } catch (error) {
                console.error('Error loading claim details:', error);
                alert('Error loading claim details');
            }
        }

        // Show action modal
        function showActionModal(action, claimId) {
            currentAction = action;
            currentClaimId = claimId;
            
            let title = '';
            let content = '';
            
            switch(action) {
                case 'finalize':
                    title = 'üë§ Human Analyst - Final Decision & Ruling';
                    content = `
                        <div class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                <p class="text-sm text-blue-700">
                                    <strong>You are making the final decision and ruling.</strong> 
                                    Review the AI analysis above and make your professional judgment.
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Final Decision (Ruling)</label>
                                <select id="final-status" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="">Select your decision...</option>
                                    <option value="APPROVED">‚úÖ Approve Claim</option>
                                    <option value="REJECTED">‚ùå Reject Claim</option>
                                    <option value="CLOSED">üîí Close Case</option>
                                    <option value="PENDING_INFORMATION">‚è≥ Request More Information</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Professional Reasoning (Ruling)</label>
                                <textarea id="final-reason" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" 
                                          placeholder="Enter your professional reasoning and ruling for this decision..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Analyst Name (Required)</label>
                                <input type="text" id="analyst-name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" 
                                       placeholder="Your full name" required>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'dictate':
                    title = 'Create Dictation';
                    content = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Dictation Text</label>
                                <textarea id="dictation-text" rows="5" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter dictation text..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Analyst Name</label>
                                <input type="text" id="analyst-name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Your name">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'close':
                    title = 'Send Closure Email';
                    content = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email Subject</label>
                                <input type="text" id="email-subject" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" value="Claim Resolution - [Claim Number]">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email Message</label>
                                <textarea id="email-message" rows="6" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter email message..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Analyst Name</label>
                                <input type="text" id="analyst-name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Your name">
                            </div>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('action-modal-title').textContent = title;
            document.getElementById('action-modal-content').innerHTML = content;
            document.getElementById('action-modal').classList.remove('hidden');
        }

        // Submit action
        async function submitAction() {
            try {
                const analystName = document.getElementById('analyst-name').value;
                
                switch(currentAction) {
                    case 'finalize':
                        const finalStatus = document.getElementById('final-status').value;
                        const finalReason = document.getElementById('final-reason').value;
                        
                        // Validate human analyst input
                        if (!analystName.trim()) {
                            alert('‚ùå Analyst name is required for the final decision');
                            return;
                        }
                        
                        if (!finalStatus) {
                            alert('‚ùå Please select a final decision');
                            return;
                        }
                        
                        if (!finalReason.trim()) {
                            alert('‚ùå Professional reasoning is required for the ruling');
                            return;
                        }
                        
                        await axios.put(`/api/analyst/claims/${currentClaimId}/status`, {
                            status: finalStatus,
                            reason: finalReason,
                            analyst_name: analystName
                        });
                        
                        alert('‚úÖ Final decision and ruling recorded successfully!');
                        break;
                        
                    case 'dictate':
                        const dictationText = document.getElementById('dictation-text').value;
                        
                        // Here you would implement the dictation functionality
                        // For now, we'll just show a success message
                        alert('Dictation created successfully!');
                        break;
                        
                    case 'close':
                        const emailSubject = document.getElementById('email-subject').value;
                        const emailMessage = document.getElementById('email-message').value;
                        
                        // Here you would implement the email sending functionality
                        // For now, we'll just show a success message
                        alert('Closure email sent successfully!');
                        break;
                }
                
                closeActionModal();
                loadDashboardStats();
                loadClaims();
                
            } catch (error) {
                console.error('Error submitting action:', error);
                alert('Error submitting action');
            }
        }

        // Close modals
        function closeClaimModal() {
            document.getElementById('claim-modal').classList.add('hidden');
            currentClaimId = null;
        }

        function closeActionModal() {
            document.getElementById('action-modal').classList.add('hidden');
            currentAction = null;
            currentClaimId = null;
        }

        // Analyze claim with LLM
        async function analyzeClaim(claimId) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'ü§ñ Analyzing...';
                button.disabled = true;
                
                const response = await axios.post(`/api/analyst/claims/${claimId}/analyze`);
                const analysis = response.data.analysis;
                
                // Show analysis results in a modal
                showAnalysisModal(analysis, claimId);
                
            } catch (error) {
                console.error('Error analyzing claim:', error);
                alert('Error analyzing claim');
            } finally {
                // Restore button state
                const button = event.target;
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Show analysis results modal
        function showAnalysisModal(analysis, claimId) {
            const modalContent = `
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                        <h4 class="text-lg font-medium text-blue-900 mb-2">ü§ñ AI Analysis Results</h4>
                        <p class="text-sm text-blue-700">Comprehensive analysis and closure recommendations</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-medium text-gray-900 mb-3">Case Summary</h5>
                            <div class="bg-gray-50 p-3 rounded-md text-sm text-gray-700">
                                ${analysis.case_summary || 'No summary available'}
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="font-medium text-gray-900 mb-3">Risk Assessment</h5>
                            <div class="bg-gray-50 p-3 rounded-md text-sm text-gray-700">
                                ${analysis.risk_assessment || 'No risk assessment available'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white border border-gray-200 rounded-md p-4">
                            <h6 class="font-medium text-gray-900 mb-2">Recommended Action</h6>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                analysis.recommended_action === 'APPROVE' ? 'bg-green-100 text-green-800' :
                                analysis.recommended_action === 'REJECT' ? 'bg-red-100 text-red-800' :
                                'bg-yellow-100 text-yellow-800'
                            }">
                                ${analysis.recommended_action || 'ANALYZED'}
                            </span>
                        </div>
                        
                        <div class="bg-white border border-gray-200 rounded-md p-4">
                            <h6 class="font-medium text-gray-900 mb-2">Suggested Amount</h6>
                            <div class="text-lg font-semibold text-gray-900">
                                ${analysis.suggested_amount ? `$${analysis.suggested_amount}` : 'Not specified'}
                            </div>
                        </div>
                        
                        <div class="bg-white border border-gray-200 rounded-md p-4">
                            <h6 class="font-medium text-gray-900 mb-2">Priority</h6>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                analysis.priority_recommendation === 'URGENT' ? 'bg-red-100 text-red-800' :
                                analysis.priority_recommendation === 'HIGH' ? 'bg-orange-100 text-orange-800' :
                                analysis.priority_recommendation === 'LOW' ? 'bg-green-100 text-green-800' :
                                'bg-blue-100 text-blue-800'
                            }">
                                ${analysis.priority_recommendation || 'NORMAL'}
                            </span>
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="font-medium text-gray-900 mb-3">Closure Reason</h5>
                        <div class="bg-gray-50 p-3 rounded-md text-sm text-gray-700">
                            ${analysis.closure_reason || 'No closure reason provided'}
                        </div>
                    </div>
                    
                    ${analysis.additional_documents_needed && analysis.additional_documents_needed.length > 0 ? `
                        <div>
                            <h5 class="font-medium text-gray-900 mb-3">Additional Documents Needed</h5>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                                ${analysis.additional_documents_needed.map(doc => `<li>${doc}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div>
                        <h5 class="font-medium text-gray-900 mb-3">Key Points</h5>
                        <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                            ${(analysis.key_points || ['Analysis completed']).map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div>
                        <h5 class="font-medium text-gray-900 mb-3">Suggested Closure Email</h5>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Subject</label>
                                <input type="text" id="suggested-subject" value="${analysis.closure_email_template?.subject || 'Claim Resolution'}" 
                                       class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Message</label>
                                <textarea id="suggested-message" rows="6" 
                                          class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm">${analysis.closure_email_template?.body || 'Please review the analysis for closure details.'}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                        <h6 class="font-medium text-yellow-900 mb-2">‚ö†Ô∏è Important: Human Decision Required</h6>
                        <p class="text-sm text-yellow-700">
                            The AI provides recommendations only. The <strong>final decision and ruling must be made by a human analyst</strong> 
                            using the "Finalize Claim" button in the claims list.
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="showActionModal('finalize', ${claimId})" 
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                            üë§ Make Human Decision
                        </button>
                        <button onclick="sendClosureEmail(${claimId})" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            üìß Send Closure Email
                        </button>
                        <button onclick="closeAnalysisModal()" 
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('action-modal-title').textContent = 'ü§ñ AI Analysis Results';
            document.getElementById('action-modal-content').innerHTML = modalContent;
            document.getElementById('action-modal').classList.remove('hidden');
            currentClaimId = claimId;
            currentAction = 'analysis';
        }

        // Apply analysis recommendation
        async function applyAnalysis(claimId, recommendedAction) {
            try {
                const status = recommendedAction === 'APPROVE' ? 'APPROVED' : 
                              recommendedAction === 'REJECT' ? 'REJECTED' : 
                              recommendedAction === 'CLOSE_CASE' ? 'CLOSED' : 'UNDER_REVIEW';
                
                await axios.put(`/api/analyst/claims/${claimId}/status`, {
                    status: status,
                    reason: 'Applied AI recommendation',
                    analyst_name: 'AI Analyst'
                });
                
                alert('Analysis recommendation applied successfully!');
                closeAnalysisModal();
                loadDashboardStats();
                loadClaims();
                
            } catch (error) {
                console.error('Error applying analysis:', error);
                alert('Error applying analysis');
            }
        }

        // Send closure email
        async function sendClosureEmail(claimId) {
            try {
                const subject = document.getElementById('suggested-subject').value;
                const message = document.getElementById('suggested-message').value;
                
                // Here you would implement the email sending functionality
                // For now, we'll just show a success message
                alert('Closure email sent successfully!');
                
            } catch (error) {
                console.error('Error sending closure email:', error);
                alert('Error sending closure email');
            }
        }

        // Close analysis modal
        function closeAnalysisModal() {
            document.getElementById('action-modal').classList.add('hidden');
            currentClaimId = null;
            currentAction = null;
        }

        // Refresh all data
        function refreshData() {
            loadDashboardStats();
            loadClaims();
        }

        // Close modals when clicking outside
        document.getElementById('claim-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeClaimModal();
            }
        });

        document.getElementById('action-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeActionModal();
            }
        });
    </script>
</body>
</html> 